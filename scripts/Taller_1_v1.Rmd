---
  title: "Taller_1_BDML"
authors: "Julian Delgado Gutierrez, Ana María Rojas, Juan David Rincón, Mario Andrés Mercado"
date: "2025-02-19"
output: html_document
editor_options: 
  markdown: 
  wrap: 72
---

  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Problem Set 1: Predicting Income

## Introduction

In the public sector, accurate reporting of individual income is
critical for computing taxes. However, tax fraud of all kinds has always
been a significant issue. According to the Internal Revenue Service
(IRS), about 83.6% of taxes are paid voluntarily and on time in the
US.1. One of the causes of this gap is the under-reporting of incomes by
individuals. An income predicting model could potentially assist in
flagging cases of fraud that could lead to the reduction of the gap.
Furthermore, an income prediction model can help identify vulnerable
individuals and families that may need further assistance.

The objective of the problem set is to apply the concepts we learned
using “real” world data. For that, we are going to scrape from the
following website:
  <https://ignaciomsarmiento.github.io/GEIH2018-sample/> This website
contains data for Bogotá from the 2018 “Medición de Pobreza Monetaria
y Desigualdad Report” that takes information from the
[GEIH.](https://www.dane.gov.co/index.php/estadisticas-por-tema/mercado-laboral/empleo-y-desempleo/geih-historicos)

### General Instructions

The main objective is to construct a model of individual hourly wages

$$w = f(X)+u$$
  
  where $w$ is the hourly wage, and $X$ is a matrix that includes
potential explanatory variables/predictors. In this problem set, we will
focus on $f(X) = X\beta$. The final document, in .pdf format, must
contain the following sections:
  
  1.  *Introduction.* The introduction briefly states the problem and if there are any antecedents. It briefly describes the data and its suitability to address the problem set question. It contains a preview of the results and main takeaways.

2. *Data.* We will use data for Bogot´a from the 2018 “Medición de Pobreza Monetaria y Desigualdad Report” that takes information from the GEIH.

The data set contains all individuals sampled in Bogota and is available at the following website <https://ignaciomsarmiento.github.io/GEIH2018-sample/>. To obtain
the data, you must scrape the website.

In this problem set, we will focus only on employed individuals older than eighteen (18) years old. Restrict the data to these individuals and perform a descriptive analysis of the variables used in the problem set. Keep in mind that in the data, there are many observations with missing data or 0 wages. I leave it to you to find a way to handle this data

When writing this section up, you must:
  
  (a) Describe the data briefly, including its purpose, and any other relevant information.
(b) Describe the process of acquiring the data and if there are any restrictions to accessing/scraping these data.
(c) Describe the data cleaning process and
(d) Descriptive the variables included in your analysis. At a minimum, you should include a descriptive statistics table with its interpretation. However, I expect a deep analysis that helps the reader understand the data, its variation, and the justification for your data choices. Use your professional knowledge to add value to this section. Do not present it as a “dry” list of ingredients.

3. *Age-wage profile.*  A great deal of evidence in *labor economics* suggests that the typical worker’s age-wage profile has a predictable path: *“Wages tend to be low when the worker is young; they rise as the worker ages, peaking at about age 50; and the wage rate tends to remain stable or decline slightly after age 50”.*
  
  In this subsection we are going to estimate the Age-wage profile profile for the individuals in this sample:
  
  
  $$log(w) = \beta_{1} + \beta_{2}Age + \beta_{3} Age^{2} + u$$
  When presenting and discussing your results, include:
  
  - A regression table.
- An interpretation of the coefficients and it’s significance.
- A discussion of the model’s in sample fit.
- A plot of the estimated age-earnings profile implied by the above equation. Including a discussion of the “peak age” with it’s respective confidence intervals. (Note: Use bootstrap to construct the confidence intervals.)

4. *The gender earnings GAP.* Policymakers have long been concerned with the gender wage gap, and is going to be our focus in this subsection.

(a) Begin by estimating and discussing the unconditional wage gap:
  
  $$log(w) = \beta_{1} + \beta_{2}Female + u$$
  where *Female* is an indicator that takes one if the individual in the sample is
identified as female.

(b) *Equal Pay for Equal Work?* A common slogan is“equal pay for equal work”. One way to interpret this is that for employees with similar worker and job characteristics, no gender wage gap should exist. Estimate a conditional earnings gap incorporating control variables such as similar worker and job characteristics.
In this section, estimate the conditional wage gap:
  
  - First, using FWL
- Second, using FWL with bootstrap. Compare the estimates and the standard errors.

(c) Next, plot the predicted age-wage profile and estimate the implied “peak ages” with the respective confidence intervals by gender

When presenting and discussing your results, include:
  
  - An estimating equation, explaining the included control variables *(beware of “bad controls”).*
  - A regression table, with the estimates side by side of the conditional and unconditional wage gaps, highlighting the coefficient of interest. Controls, should
not be included in the table but dutifully noted.
- An interpretation of the“Female” coefficients, a comparison between the models, and the in-sample fit.
- A discussion about the implied peak ages and their statistical similarity/difference.
- A thoughtful discussion about the unconditional and conditional wage gap, seeking to answer if the changes in the coefficient are evidence of a selection problem, a ”discrimination problem,” a mix, or none of these issues.


5. *Predicting earnings.* In the previous sections, you estimated some specifications with
inference in mind. In this subsection, we will evaluate the predictive power of these
specifications.

(a) Split the sample into two: a training (70%) and a testing (30%) sample. (Don’t forget to set a seed to achieve reproducibility. In R, for example you can use set.seed(10101), where 10101 is the seed.)

(b) Report and compare the predictive performance in terms of the RMSE of all
the previous specifications with at least five (5) additional specifications that
explore non-linearities and complexity.

(c) In your discussion of the results, comment:
  
  - About the overall performance of the models.
- About the specification with the lowest prediction error.
- For the specification with the lowest prediction error, explore those observations that seem to ”miss the mark.” To do so, compute the prediction errors
in the test sample, and examine its distribution. Are there any observations
in the tails of the prediction error distribution? Are these outliers potential
people that the DIAN should look into, or are they just the product of a
flawed model?
  
  (d) LOOCV. For the two models with the lowest predictive error in the previous section, calculate the predictive error using Leave-one-out-cross-validation
(LOOCV). Compare the results of the test error with those obtained with the
validation set approach and explore the potential links with the influence statistic. (Note: when attempting this subsection, the calculati                                                                                
                                                                                       
# Configuración Inicial
```{r setup, include=FALSE}
# Limpiar espacio, conexiones y bases de datos
rm(list = ls())
gc()
closeAllConnections()

# Cargar librerías necesarias
load.lib <- c('data.table', 'dplyr', 'ggplot2', 'stargazer', 'tidyverse', 'lubridate',
'plotly', 'rvest', 'tm', 'wordcloud', 'caret', 'boot', 'pacman', 'skimr')

# Instalar librerias faltantes
install.lib <- load.lib[!load.lib %in% installed.packages()]
for(lib in install.lib) install.packages(lib)
sapply(load.lib, require, character = TRUE)

```

# Punto 2: Apartado A - Web Scraping de GEIH
```{r scraping, include=FALSE}
# Definir URL de donde se saca la información
url_base <- "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_page_"

# Usar read_html para traer tabla de la primera página
pagina <- read_html(paste0(url_base, "1.html"))
datos_totales <- pagina %>% html_table(fill = TRUE) %>% .[[1]]

# Traer información de las bases 2 a la 10 e ir uniendo las bases en el camino
for (i in 2:10) {
url <- paste0(url_base, i, ".html")
tryCatch({
pagina <- read_html(url)
tabla <- pagina %>% html_table(fill = TRUE) %>% .[[1]]
datos_totales <- bind_rows(datos_totales, tabla)
}, error = function(e) {
message(paste("Error al cargar la página", i, ":", e))
})
}

# Mostrar primeras observaciones de la tabla
head(datos_totales)
```

# Punto 2: Apartado A
Una vez se combinan los datos y se obtiene la base completa, se evidencia que hay información que nos permite analizar el mercado laboral y variables ecónomicas de diferentes individios. Se encuentra que el objetivo principal de la base de datos es analizar ingresos (salario) y comportamientos del mercado. Hay variables que nos permiten analizar características individuales como la edad, género, educación, departamento, entre otras y variables que se relacionan con la actividad laboral como los ingresos, horas trabajadas, tipo de empleo, sector económico, entre otras. La selección de las variables es clave puesto que permitirá evaluar los factores que influyen en el ingreso y analizar fenómenos como la brecha salarial de género. De igual forma, es importante mencionar que la base tiene valores faltantes y observaciones con ingreso igual a cero, lo que sugiere la necesidad de un proceso de limpieza antes del análisis. La base tiene una estructura de formato tabular, la cual facilita el procesamiento de los datos y el análisis de los mismos mediante descripciones estadísticas. Adicionalmente, se considera que los datos proporcionados son fundamentales para construir un modelo predictivo de ingresos por hora y detectar como variables sociodemográficas y laborales inciden en la remuneración de los individuos.

# Punto 2: Apartado B

En primer lugar hay que tener presente que los datos no se pueden descargar como un archivo, sino que se encuentran en un página web (<https://ignaciomsarmiento.github.io/GEIH2018_sample/>), por lo cual, es necesario hacer web scrapping para extraerlos. Los datos estaban distribuidos en diferentes sitios web, por lo se combinaron en un único conjunto de datos. De esta forma, se difinió la base de la URL, donde cada página se nombró siguiendo un patrón (geih_page_1.html", "geih_page_2.html ..., etc). Con ayuda de la libreria rvest se leyó el contenido HTML de cada página (data chunk 1:10), se extrajeron las tablas y se combinaron los datos en un solo dataframe, almacenando el resultado en la variables datos_totales. Para evitar que el código fuese a generar error en caso de que una de las páginas no cargara correctamente, se utilizó tryCatch (manejo de errores). De esta forma, se buscaba que si las páginas cargaban correctamente, se extrayera las tablas y se añadieran a la variable "datos_totales" y si se llegaba a presentar algún problema de lectura, se captaría el error sin detener la ejecución total. Por lo tanto, el código permite automatizar el proceso de recolección de datos que están distribuidores en diferentes sitios web y cuando se trabaja con grandes volúmenes de datos, aún si se presenta algún problema. No se encuentran restricciones dado que la página no tiene capchas ni bloqueos para la extracción de datos, pero tuvimos presente no hacer múltiples solicitudes en un corto período de tiempo para no sobrecargar el servidor. Por el otro lado, los datos son públicos y fueron diseñados para fines académicos, por lo que facilito en gran medida el scrapping.

# Renombrar Columnas y Limpiar Datos
```{r limpieza, include=FALSE}
# Renombrar variables principales a utilizar
datos_totales <- datos_totales %>%
  rename(ingreso_total = ingtot,
         edad = age,
         hombre = sex,
         T_horas_trabajadas = totalHoursWorked,
         Salario_hora = y_salary_m_hu
  ) %>%
  mutate(
    ln_Salario_hora = log(Salario_hora)
  )

# Filtrar registros inválidos (menor de 18 años o que no trabaja)
datos_filtrados <- datos_totales %>%
  filter(edad > 18, ingreso_total > 0, T_horas_trabajadas > 0, Salario_hora > 0)

# Identificar y eliminar outliers usando percentiles 1% y 99%
low_hours <- quantile(datos_filtrados$T_horas_trabajadas, 0.01)
up_hours <- quantile(datos_filtrados$T_horas_trabajadas, 0.99)
low_salary <- quantile(datos_filtrados$Salario_hora, 0.01)
up_salary <- quantile(datos_filtrados$Salario_hora, 0.99)

datos_filtrados <- datos_filtrados %>%
  filter(T_horas_trabajadas >= low_hours & T_horas_trabajadas <= up_hours,
         Salario_hora >= low_salary & Salario_hora <= up_salary)
```

# Revisión de Variables y Missing Values
```{r dividir_datos, include=FALSE}
# Ver estadísticas descriptivas, NAs y histograma de variables seleccionadas
skim(datos_filtrados) 

# Calcular el porcentaje de NAs de cada variable y borrar variables con NAs > 90%
miss_values <- skim(datos_filtrados) %>% select( skim_variable, n_missing)
Nobs <- nrow(datos_filtrados) 
miss_values <- miss_values %>% mutate(p_missing= n_missing/Nobs)
miss_values <- miss_values %>% arrange(-n_missing)

# Borrar aquellas variables con más del 90% de missing values ya que imputarlas puede traer más ruido 
var_miss <- miss_values %>% filter (p_missing > 0.9)
base_seleccionada <- datos_filtrados %>% select(-all_of(var_miss[[1]]))
print(base_seleccionada) 
```

# Correlación entre variables para seleccionar más relevantes
```{r dividir_datos, include=FALSE}
# Seleccionar variables para cambiar formato 
numericas <- base_seleccionada %>% select(-all_of(c("y_ingLab_m_ha", "y_total_m_ha", "p6500", "y_salary_m", "impa", "y_ingLab_m", "y_total_m", "ingtotob", "ingreso_total")))
numericas <- numericas[, sapply(numericas, is.numeric)]

# Filtrar las columnas con desviación estándar diferente a cero y sin valores NA
numericas_filtradas <- numericas[, sapply(numericas, function(x) {
  !all(is.na(x)) && sd(x, na.rm = TRUE) != 0
})]
summary(numericas_filtradas)

# Calcular la correlación de cada variable con salario por hora y encontrar variables que más se correlacionan
correlaciones_con_y <- sapply(numericas_filtradas, function(x) cor(x, numericas$Salario_hora, use = "complete.obs"))
resultados_correlacion <- data.frame(Variable = names(correlaciones_con_y), Correlacion_con_y = correlaciones_con_y)
print(resultados_correlacion)
correlaciones_abs <- abs(correlaciones_con_y)
correlaciones_abs_sorted <- sort(correlaciones_abs, decreasing = TRUE)
print(correlaciones_abs_sorted)

# Seleccionar 25 variables con mayor correlación
top_25_vars <- names(correlaciones_abs_sorted)[1:25]
top_25_correlaciones <- data.frame(Variable = top_25_vars,
                                   Correlacion_con_y = correlaciones_abs_sorted[1:25])
print(top_25_correlaciones)
write.csv(top_25_correlaciones, "correlacion_variables.csv", row.names = TRUE)
```

# Punto 2: Apartado C
En primer lugar, se consideró necesario renombrar ciertas variables como edad, sexo, ingreso total para facilidad de lectura del grupo y se creó una variable "ln_Salario_hora", a la cual se le aplicó logarítmo natural para facilitar el análisis de regresión posterior. De acuerdo al enunciado del problem set, se identificó qué debíamos filtrar la base por aquellos individuos empleados mayores de 18 años. Por lo cual, se filtraron los datos para las muestras mayores a 18 años, donde el ingreso total fuese mayor a cero y tanto las horas trabajadas como el salario por hora fuese mayor a cero. Adicionalmente, se identificaron y eliminaron outliers extremos para las variables de horas trabajadas y salario por hora usando percentiles 1% y 99% con el fin de que dichos valores atípicos distorsionen las interpretaciones de los resultados. Posteriormente, se seleccionaron únicamente variables númericas y se elimnaron aquellas con desviación estándar igual a cero, puesto que no aporta variabilidad al modelo. Asimismo, las variables NA dado que no tienen información útil. 

Teniendo en cuenta que la base completa era bastante amplia, se decidió calcular la correlación de cada variable numérica con Salario_hora y de esta forma, se seleccionaron las 25 variables con mayor correlación puesto que serían las más relevantes para analizar. Adicionalmente, se consideraron otras variables como la edad, el género, etc  dado que estas variables han sido ampliamente estudiadas en investigaciones económicas y del mercado laboral, demostrando efectos significativos en los ingresos. De este modo, las variables relevantes para el análisis son de características individuales (edad, genero, educación (college, maxEducLeval)), características laborales (oficio, informalidad, horas trabajadas), características económicas (ingresos, estrato) y así se crea un nuevo dataframe con solo estas variables para reducir la dimensionalidad de la base. 

# Selección de variables relevantes
```{r dividir_datos, include=FALSE}
# Seleccionar variables importantes para el modelo (basado en correlación e intuición económica)
variables_seleccionadas <- c("edad", "hombre", "college", "maxEducLevel", "informal", "formal", "microEmpresa", "Salario_hora", "ingtotes", "impa", "isa", "p6500", "p6510", "p6580", "p6750", "p7070", "cotPension", "p6920", "hoursWorkUsual", "hoursWorkActualSecondJob", "fex_c", "fweight", "oficio", "estrato1", "ln_Salario_hora")
base_seleccionada <- datos_filtrados %>% select(all_of(variables_seleccionadas))
str(base_seleccionada)

```

Punto 2: Apartado D - Estadísticas Descriptivas y Gráficos (Estadísticas Descriptivas)
```{r dividir_datos, include=FALSE}
# Calcular estadísticas descriptivas y correlación
tabla_descriptiva <- summary(base_seleccionada)
print(tabla_descriptiva)

# Exportar tablas
write.csv(tabla_descriptiva, "estadisticas_descriptivas.csv", row.names = TRUE)
```

# Calcular rangos de edades
```{r dividir_datos, include=FALSE}
# Crear grupos de edad (facilidad de uso) y ajustar formatos
base_seleccionada$grupo_edad <- cut(base_seleccionada$edad, 
                                    breaks = c(-Inf, 20, 30, 40, 50, 60, 70, Inf), 
                                    labels = c("<20", "20-30", "30-40", "40-50", "50-60", "60-70", ">70"),
                                    right = FALSE)
base_seleccionada$hombre <- as.factor(base_seleccionada$hombre)

# Calcular el promedio de ingresos por grupo de edad y género
promedio_ingresos <- base_seleccionada %>%
  group_by(grupo_edad, hombre, maxEducLevel, oficio, estrato1) %>%
  summarise(promedio = mean(Salario_hora, na.rm = TRUE))
```

Punto 2: Apartado D - Estadísticas Descriptivas y Gráficos (Gráficos)
```{r dividir_datos, include=FALSE}
# Gráfica barras Edad e ingresos (por genero)
ggplot(promedio_ingresos, aes(x = grupo_edad, y = promedio, fill = hombre)) +
  geom_bar(stat = "identity", position = "dodge") +  # position = "dodge" coloca las barras al lado
  labs(title = "Promedio de ingresos por rango de edad y género", x = "Grupo de Edad", y = "Promedio de Ingresos", fill = "Hombre") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  )
ggsave("barras_edad_ingresos.png", width = 8, height = 6, dpi = 300)

# Gráfica barras Estrato e ingresos (por genero)
ggplot(promedio_ingresos, aes(x = estrato1, y = promedio)) +
  geom_bar(stat = "identity", position = "dodge") +  # position = "dodge" coloca las barras al lado
  labs(title = "Promedio de ingresos por estrato y género", x = "Estrato", y = "Promedio de Ingresos") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  )
ggsave("barras_estrato_ingresos.png", width = 8, height = 6, dpi = 300)

# Gráfica barras Nivel Educativo e ingresos (por genero)
ggplot(promedio_ingresos, aes(x = maxEducLevel, y = promedio, fill = hombre)) +
  geom_bar(stat = "identity", position = "dodge") +  # position = "dodge" coloca las barras al lado
  labs(title = "Promedio de ingresos por nivel educativo y género", x = "Nivel de Educación", y = "Promedio de Ingresos", fill = "Hombre") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("barras_educacion_ingresos.png", width = 8, height = 6, dpi = 300)

# Gráfica barras Ingresos y Oficio (por genero)
ggplot(promedio_ingresos, aes(x = oficio, y = promedio, fill = hombre)) +
  geom_bar(stat = "identity", position = "dodge") +  # position = "dodge" coloca las barras al lado
  labs(title = "Promedio de ingresos por oficio y género",x = "Oficio", y = "Promedio de Ingresos", fill = "Hombre") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("barras_oficio_ingresos.png", width = 8, height = 6, dpi = 300)


# Gráfica Dispersión Horas Trabajadas por salario
ggplot(data = base_seleccionada, 
       mapping = aes(x = hoursWorkUsual, y = Salario_hora, 
                     group = as.factor(formal), color = as.factor(formal))) +
  geom_point() +
  labs(
    title = "Relación entre Horas de Trabajo y Salario por Hora",  x = "Horas Usuales de Trabajo", y = "Salario por Hora") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("dispersion_horas_salario.jpeg", width = 8, height = 6, dpi = 300)


# Gráfica Dispersión Oficio por salario
ggplot(data = base_seleccionada , 
       mapping = aes(x = oficio , y = Salario_hora , group=as.factor(formal) , color=as.factor(formal))) +
  geom_point() +
  labs(
    title = "Relación entre Oficio y Salario por Hora",  x = "Horas Usuales de Trabajo", y = "Salario por Hora") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("dispersion_oficio_salario.jpeg", width = 8, height = 6, dpi = 300)

# Gráfica Dispersión Estrato por salario
ggplot(data = base_seleccionada , 
       mapping = aes(x = estrato1 , y = Salario_hora , group=as.factor(formal) , color=as.factor(formal))) +
  geom_point() +
  labs(
    title = "Relación entre Estrato y Salario por Hora",  x = "Horas Usuales de Trabajo", y = "Salario por Hora") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("dispersion_estrato_salario.jpeg", width = 8, height = 6, dpi = 300)

# Gráfica Caja Bigotes Estrato y Promedio ingresos
ggplot(data = promedio_ingresos, 
       mapping = aes(x = as.factor(estrato1), y = promedio)) + 
  geom_boxplot() +
  labs(title = "Distribución de Ingresos por Estrato", x = "Estrato", y = "Promedio de Ingresos") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("boxplot_estrato_ingresos.png", width = 8, height = 6, dpi = 300)

```
# Punto 2: Apartado D - Estadísticas Descriptivas y Gráficos (Interpretación)

La tabla #1 corresponde a las estadísticas descriptivas de las variables seleccionadas (aquellas con una correlación significativa y aquellas ampliamente estudiadas). En primer lugar, se analizan las variables demográficas. Se evidencia que los individuos están entre los 19 y los 86 años de edad, con una media de 36.3 años lo que sugiere que la muestra poblacional está en edad laboral. La media de la variable de género (hombre) es de 0.5038, lo que indica que hay una distrinución equilibrada entre hombres y mujeres. A partir de la variable  maxEducLevel se evidencia que la mayoría de la población tiene al menos educación secundaria o técnica, dado que la media es 6 y a partir de college se evidencia que el alrededor del 35% de la muestra ha alcanzado la educación superior (universitaria), dado que la media es de 0.3474. De esta forma, se puede concluir que la muestra incluye una población trabajadora en su mayoría joven-adulta, con igualdad de representación entre hombres y mujeres y un nivel educativo medio-alto. 

En segundo lugar, se analizan las variables laborales y se encuentra a partir de la variable "informal" que el 21.41% de la muestra está en el sector informal (informal = 0.2141), mientras que el 78.59% está en el sector formal (formal = 0.7859). Adicionalmente, se encuentra por medio de la variable "hoursWorkUsual" que la mayoría trabaja jornadas laborales completas puesto que la media es de 48.13 horas y que no hay individuos independientes dado que la media de la variable "cuenta propia" es cero. 

En tercer lugar, se analizan las variables económicas y se encuentra la variable de Salario por hora, la cual tiene un rango de 1,215 a 58,333, con una mediana de 4,555 y una media de 7,291.La gran diferencia entre media y mediana sugiere que hay valores extremos que elevan el promedio. La variable de ingreso total(ingtotes) muestra una gran dispersión en los valores, con un máximo de 8 millones. La media (434,783) es significativamente mayor a la mediana (191,834), indicando la presencia de ingresos muy elevados en la parte alta de la distribución y, por medio de Logaritmo del salario (ln_Salario_hora) se evidencia que los ingresos siguen una distribución normal. Es decir, los ingresos presentan una fuerte dispersión y una distribución sesgada con valores muy altos en la parte superior. Esto refuerza la necesidad de usar el logaritmo del salario en los modelos de regresión para reducir heterocedasticidad. 

Finalmente, se analizan las variables sociales y se encuentra a partir de la variable de estrato socioeconómico que la población está en estratos medios-bajos pues la media es de 2.491. Sin embargo, se encuentra un máximo de 6, lo que refleja la diversidad de condiciones socioeconómicas en la muestra. Por medio de la variable (cotPension), se evidencia que la mayoría de los trabajadores están afiliados a pensión pues la media de 1.232 indica que más del 50% cotiza. De esta forma, el acceso a la seguridad social está presente en una parte importante de la población, pero es posible que una proporción significativa no cotice. La distribución de estratos refleja la heterogeneidad económica en Bogotá. En conclusión, la población trabajadora se compone principalmente por adultos jóvenes con una distribución casi equitativa entre hombres y mujeres. La mayoría de los trabajadores están en el sector formal y con jornadas laborales completas, aunque hay presencia de informalidad y posibles casos de sobreempleo. Los ingresos presentan una alta dispersión, con valores extremos que sesgan la media hacia valores elevados.Existe una diversidad en niveles educativos y estratos socioeconómicos, lo que puede ser clave en la modelización del salario.

Para completar el análisis de las estadísticas descriptivas, se consideró pertinente ver la relación gráfica entre la variable salario y otras variables de interés como las mencionadas anteriormente. La primera relación que encontramos es la de la Figura 1. "Age-Earnings Profile", en el que se muestra la relación entre la edad y el salario por hora estimado. Se observa una curva en forma de U cóncava, lo que sugiere que los ingresos tienden a aumentar con la edad hasta un punto máximo alrededor de los 45-50 años y luego disminuyen progresivamente. Esto puede explicarse por la acumulación de experiencia y educación en la primera mitad de la vida laboral, seguida por una posible reducción en la intensidad del trabajo, jubilación o cambios en el tipo de empleo en una edad mayor. 

En la Figura 2."Ingresos promedio por grupo de edad y género", se evidencian los ingresos promedio por grupo de edad y se diferencia entre hombres (azul) y mujeres (rojo). Se analiza que en la mayoría de los grupos de edad, los hombres tienden a tener ingresos más altos que las mujeres, aunque en algunos rangos (como 40-50 años) la diferencia es menor. Hay una tendencia similar al primer gráfico, donde los ingresos crecen con la edad hasta un punto máximo entre 40-60 años y luego disminuyen en el grupo de mayores de 70 años. El grupo de menores de 20 años, tiene los ingresos más bajos, lo cual tiene sentido puesto que están en etapas de educación o comenzando la carrera laboral. Ambos gráficos reflejan una relación clara entre la edad y los ingresos, con un punto máximo alrededor de los 40-50 años y una posterior disminución. También se observa una brecha de género en los ingresos, con los hombres ganando más en la mayoría de las edades. Esto puede estar influenciado por diferencias en acceso a empleos mejor remunerados, interrupciones laborales en el caso de las mujeres (embarazo) y otros factores estructurales del mercado laboral. 

En la Figura 3. "Ingresos promedio por estrato" se muestra la relación entre el estrato socioeconómico y el ingreso promedio de la muestra poblacional. Se observa una relación positiva entre estrato e ingresos, puesto que a medida que el estrato aumenta, el ingreso promedio también crece. Esto es posible, ya que los estratos más altos suelen tener acceso a mejores oportunidades económicas y educativas. Sin embargo, se evidencia una gran diferencia entre el estrato 1 (el más bajo) y los estratos superiores. Por ejemplo, el estrato 1 tiene ingresos muy bajos en comparación con el estrato 2, que experimenta un fuerte incremento.Los estratos 5 y 6 tienen ingresos similares, por lo que no se observa un aumento significativo entre estos dos estrato. Esto indica que, a partir de cierto punto, el crecimiento del ingreso se estabiliza.Este gráfico refleja la desigualdad económica y cómo el acceso a recursos (vivienda, educación) influye en los ingresos. 

La Figura 4. " Ingresos promedio por nivel de educación" muestra cómo el nivel educativo impacta en el ingreso promedio, diferenciando entre hombres (azul) y mujeres (rojo).Se evidencia una clara relación positiva entre el nivel educativo y el ingreso promedio. Aquellos con mayor nivel de estudios obtienen ingresos significativamente más altos. Asimismo, se evidencia que en los niveles educativos más bajos, las diferencias salariales entre hombres y mujeres se perciben, mientras que a medida que aumenta el nivel educativo, las diferencias de género se reducen, especialmente en los niveles más altos donde los ingresos parecen igualarse. El salto en ingresos entre los niveles educativos bajos y altos es notable. La diferencia entre los que tienen poca educación y los que alcanzan niveles universitarios es muy marcada.Este gráfico refuerza la importancia de la educación como un determinante clave de los ingresos y sugiere que una mayor escolaridad puede ser una vía para mejorar las condiciones económicas.

En la Figura 6. "Salario-hora por horas de trabajo" se muestra la relación entre las horas de trabajo (eje X) y el salario por hora (eje Y), diferenciando entre trabajadores formales (azul) e informales (rojo).Principalmente, se observa que los trabajadores formales tienden a tener salarios por hora más altos, con una mayor dispersión de valores en la parte superior del gráfico, mientras que los trabajadores informales se concentran en los niveles más bajos de salario por hora, con pocos casos de ingresos altos. Asimismo, se observa que la mayoría de los trabajadores se agrupan entre 30 y 60 horas semanales. No hay una clara tendencia de aumento del salario por hora con más horas trabajadas, lo que indica que la cantidad de horas no garantiza mejores ingresos. Finalmente, se observa que hay trabajadores informales con techo de ingresos dado que casi todos los puntos rojos están en la parte baja del gráfico, lo que indica que presentan limitaciones salariales y no alcanzan los mismo niveles salariales que los trabajadores formales.Por último, se analiza 

la Figura 9. "Boxplot promedio de ingresos por estrato", la cual muestra la distribución de los ingresos promedio en función del estrato socioeconómico. Se encuentra una tendencia creciente de ingresos con respecto al estrato. Los estratos más bajos (1, 2 y 3) tienen ingresos considerablemente menores y con menor dispersión, mientras que los estratos altos (4, 5 y 6) presentan ingresos más elevados y una mayor variabilidad. Por otro lado, se encuentra que en los estratos 1, 2 y 3, los ingresos están muy concentrados en valores bajos, con algunas excepciones representadas por los outliers. A partir del estrato 4, la mediana de los ingresos aumenta notablemente y la dispersión de los datos es mucho mayor. El estrato 6 tiene la distribución más amplia, lo que indica una mayor diferencia entre quienes ganan poco y quienes ganan mucho dentro de este grupo. Es importante mencionar que se observan outliers en todos los estratos, pero en los más bajos estos outliers son menos frecuentes y no tan extremos, mientras que en los estratos más altos, la presencia de valores atípicos con ingresos significativamente altos sugiere que hay grupos reducidos de personas con ingresos muy elevados. 

De esta manera, se puede concluir que hay una fuerte relación entre variables socioeconómicas y los ingresos de la población. Se observa que el nivel de ingresos aumenta con la edad hasta cierto punto, mostrando un pico, con diferencias notables entre hombres y mujeres. Asimismo, el estrato socioeconómico y el nivel educativo tienen un impacto significativo en los ingresos, donde los estratos altos y las personas con mayor nivel educativo perciben salarios más elevados. Además, el mercado laboral presenta disparidades entre el empleo formal e informal, con trabajadores formales obteniendo mayores salarios por hora, aunque con una variabilidad considerable. Finalmente, la distribución de ingresos refleja altos niveles de desigualdad, especialmente en los estratos más altos, donde hay una mayor dispersión y presencia de outliers con ingresos significativamente altos. Estos resultados demuestran la importancia de desarrollar políticas públicas que promuevan el acceso a la educación y la formalización del empleo como estrategias clave para reducir las brechas económicas y laborales.



# Punto 3: Regresión

```{r modelo1, include=FALSE}
# Crear variable al cuadrado de edad
base_seleccionada$edad_cuadrado <- base_seleccionada$edad^2

# Correr regresión según modelo taller
punto_3 <- lm(ln_Salario_hora ~ edad + edad_cuadrado, data = base_seleccionada)

# Sacar coeficientes y resultados de la regresión
summary(punto_3)
capture.output(summary(punto_3), file = "resumen_regresion.txt")
```
# Punto 3: Interpretación y discusión del modelo

La primera tabla muestra la estimación de un modelo de regresión para explicar el logaritmo del salario por hora (ln_salario_hora) en función de la edad y la edad al cuadrado. En primer lugar, se analiza el coeficiente "edad", donde edad = 0.054, p<0.01. Se encuentra que por cada año adicional de edad, el salario por hora aumenta 5,4%, manteniendo constantes las demás variables. El error estándar es pequeño (0.003), lo que sugiere que la estimación es precisa. Dado que el coeficiente es estadísticamente significativo a un nivel del 1% (p<0.01), hay fuerte evidencia de que la edad tiene un impacto positivo en los salarios por hora. En segundo lugar, se analiza la edad al cuadrado, donde edad_squared = -0.001, p<0.01. El coeficiente negativo sugiere que, a medida que aumenta la edad, el crecimiento del salario por hora se desacelera. Es decir, la relación entre edad e ingresos sigue una curva cuadrática (cóncava), lo que indica que hay un punto máximo a partir del cual los salarios dejan de crecer y comienzan a disminuir. También es significativo a un nivel del 1% (p<0.01), lo que confirma que esta relación cuadrática es relevante en el modelo. La constante igual a 7.527 representa el valor de ln_salario_hora cuando edad = 0. Su valor elevado sugiere que, en términos logarítmicos, los salarios de referencia sin considerar la edad son relativamente altos. 

Por otro lado, se considera necesario analizar los indicadores estadísticos del modelo. Por ejemplo, observamos que la muestra usada en la estimación del modelo incluye 9423 individuos. El R² indica que el modelo solo explica el 3.5% (0.035) de la variabilidad en los salarios por hora, lo cual nos indica que hay otros factores importantes que determinan el salario y que no están incluidos en el modelo como educación, experiencia o sector de empleo. El error estándar residual (0.634) muestra la dispersión de los errores del modelo, indicando qué tan lejos están los valores reales de los valores predichos en promedio. Finalmente, se logra concluir que el modelo es globalmente significativo dado que valor p del Estadístico F es menos a 0.01 se logra rechazar la hipótesis nula de que todos los coeficientes son iguales a cero. 

Siendo así, el modelo sugiere que el salario por hora aumenta con la edad, pero a un ritmo decreciente, alcanzando un punto máximo antes de empezar a disminuir. Sin embargo, el bajo R² indica que la edad por sí sola no es un buen predictor del salario y que se necesitan otras variables (como nivel educativo, experiencia, género, sector laboral, etc.) para explicar mejor la variabilidad en los ingresos.

# Punto 3: Gráfica edad e ingresos, edad pico e intervalo de confianza
```{r dividir_datos, include=FALSE}
# Gráfica de edad y salario 
rango_edad <- seq(min(base_seleccionada$edad), max(base_seleccionada$edad), length.out = 100)
rango_edad_cuadrado <- rango_edad^2
salario_predicho_ln <- predict(punto_3, newdata = data.frame(edad = rango_edad, edad_cuadrado = rango_edad_cuadrado))
salario_predicho <- exp(salario_predicho_ln)
datos_grafica <- data.frame(edad = rango_edad, salario_predicho = salario_predicho)
grafica <- ggplot(datos_grafica, aes(x = edad, y = salario_predicho)) +
  geom_line() + 
  labs(title = "Perfil Estimado de Edad e Ingresos", x = "Edad", y = "Salario Horario Predicho") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"))
ggsave("punto_3.jpeg", width = 8, height = 6, dpi = 300)


# Edad pico e intervalos de confianza (Bootstrap)
edad_pico <- -coef(punto_3)["edad"] / (2 * coef(punto_3)["edad_cuadrado"])
print(paste("Edad Pico:", round(edad_pico, 2)))

# Definir y realizar bootstrap
n_bootstraps <- 1000 
edad_picos_bootstrap <- replicate(n_bootstraps, {
  datos_bootstrap <- base_seleccionada[sample(nrow(base_seleccionada), replace = TRUE), ]
  modelo_bootstrap <- lm(ln_Salario_hora ~ edad + edad_cuadrado, data = datos_bootstrap)
  -coef(modelo_bootstrap)["edad"] / (2 * coef(modelo_bootstrap)["edad_cuadrado"])
})

# Mostrar intervalo de confianza
limite_inferior_ci <- quantile(edad_picos_bootstrap, 0.025)
limite_superior_ci <- quantile(edad_picos_bootstrap, 0.975)
print(paste("Intervalo de Confianza", paste("(", round(limite_inferior_ci, 2), ",", round(limite_superior_ci, 2), ")")))

```

#Punto 5: 

# Dividir Datos en Entrenamiento y Prueba

```{r dividir_datos, include=FALSE}
set.seed(10101)
datos_filtrados$id <- 1:nrow(datos_filtrados)
datos_entrenamiento <- datos_filtrados %>% sample_frac(0.7)
datos_prueba <- datos_filtrados %>% anti_join(datos_entrenamiento, by = "id")

cat("Tamaño del conjunto de entrenamiento:", nrow(datos_entrenamiento), "\n")
cat("Tamaño del conjunto de prueba:", nrow(datos_prueba), "\n")
```

# Modelos de Regresión

## Modelo 1: Constante

```{r modelo1, include=FALSE}
modelo1 <- lm(ln_Salario_hora ~ 1, data = datos_entrenamiento)
summary(modelo1)
```

## Modelo 2: Edad y Edad\^2

```{r modelo2, include=FALSE}
modelo2 <- lm(ln_Salario_hora ~ edad + I(edad^2), data = datos_entrenamiento)
summary(modelo2)
```

## Modelo 3: Género y Edad

```{r modelo3, include=FALSE}
modelo3 <- lm(ln_Salario_hora ~ hombre + edad, data = datos_entrenamiento)
summary(modelo3)
```

# Evaluación de Modelos (RMSE)

```{r evaluacion, include=FALSE}
rmse <- function(actual, predicho) {
sqrt(mean((actual - predicho)^2))
}

datos_prueba$prediccion_m1 <- predict(modelo1, newdata = datos_prueba)
datos_prueba$prediccion_m2 <- predict(modelo2, newdata = datos_prueba)
datos_prueba$prediccion_m3 <- predict(modelo3, newdata = datos_prueba)

rmse_m1 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m1)
rmse_m2 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m2)
rmse_m3 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m3)

cat("RMSE Modelo 1:", round(rmse_m1, 4), "\n")
cat("RMSE Modelo 2:", round(rmse_m2, 4), "\n")
cat("RMSE Modelo 3:", round(rmse_m3, 4), "\n")
```

# Intervalos de Confianza mediante Bootstrap

```{r bootstrap, include=FALSE}
# Función para bootstrap del coeficiente de edad
boot_fn <- function(data, indices) {
modelo_boot <- lm(ln_Salario_hora ~ edad + I(edad^2), data = data[indices, ])
return(coef(modelo_boot))
}

boot_results <- boot(datos_entrenamiento, boot_fn, R = 1000)

# Intervalo de confianza al 95% para el coeficiente de edad
boot.ci(boot_results, type = "perc", index = 2)
```

# Visualización de la Curva de Edad-Ingreso

```{r curva_edad_ingreso, include=FALSE}
edad_seq <- data.frame(edad = seq(min(datos_entrenamiento$edad), max(datos_entrenamiento$edad), by = 1))
edad_seq$ln_Salario_hora_pred <- predict(modelo2, newdata = edad_seq)

curv_edad_salario <- ggplot(datos_entrenamiento, aes(x = edad, y = ln_Salario_hora)) +
geom_point(alpha = 0.3) +
geom_line(data = edad_seq, aes(x = edad, y = ln_Salario_hora_pred), color = "blue") +
labs(title = "Curva de Edad vs. Log Salario Hora",
x = "Edad", y = "Log Salario Hora")

print(curv_edad_salario)
```

# Comparación entre Modelos Condicionales y No Condicionales

```{r comparacion_modelos, include=FALSE}
modelo_sin_controles <- lm(ln_Salario_hora ~ hombre, data = datos_entrenamiento)
modelo_con_controles <- lm(ln_Salario_hora ~ hombre + edad + T_horas_trabajadas, data = datos_entrenamiento)

stargazer(modelo_sin_controles, modelo_con_controles, type = "text", title = "Comparación de Modelos")
```

# Validación Cruzada (5-fold)

```{r validacion_cruzada, include=FALSE}
train_control <- trainControl(method = "cv", number = 5)
modelo_cv <- train(ln_Salario_hora ~ edad + I(edad^2), data = datos_entrenamiento, method = "lm", trControl = train_control)
print(modelo_cv)
```

# Modelos Adicionales (Polinomiales e Interacciones)

```{r modelos_adicionales, include=FALSE}
modelo4 <- lm(ln_Salario_hora ~ poly(edad, 3, raw = TRUE), data = datos_entrenamiento)
modelo5 <- lm(ln_Salario_hora ~ hombre * edad, data = datos_entrenamiento)
modelo6 <- lm(ln_Salario_hora ~ hombre + edad + I(edad^2) + T_horas_trabajadas, data = datos_entrenamiento)
modelo7 <- lm(ln_Salario_hora ~ poly(edad, 2) + log(T_horas_trabajadas), data = datos_entrenamiento)

# Predicciones y RMSE para los nuevos modelos
datos_prueba$prediccion_m4 <- predict(modelo4, newdata = datos_prueba)
datos_prueba$prediccion_m5 <- predict(modelo5, newdata = datos_prueba)
datos_prueba$prediccion_m6 <- predict(modelo6, newdata = datos_prueba)
datos_prueba$prediccion_m7 <- predict(modelo7, newdata = datos_prueba)

rmse_m4 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m4)
rmse_m5 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m5)
rmse_m6 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m6)
rmse_m7 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m7)
```

# Mostrar los resultados de RMSE para todos los modelos

```{r resultados_rmse, include=FALSE}
cat("RMSE Modelo 1:", round(rmse_m1, 4), "\n")
cat("RMSE Modelo 2:", round(rmse_m2, 4), "\n")
cat("RMSE Modelo 3:", round(rmse_m3, 4), "\n")
cat("RMSE Modelo 4:", round(rmse_m4, 4), "\n")
cat("RMSE Modelo 5:", round(rmse_m5, 4), "\n")
cat("RMSE Modelo 6:", round(rmse_m6, 4), "\n")
cat("RMSE Modelo 7:", round(rmse_m7, 4), "\n")
```

# Comparación gráfica de los errores de predicción entre los modelos

```{r comparacion_grafica, include=FALSE}
mse_values <- data.frame(
Modelo = c("Modelo 1", "Modelo 2", "Modelo 3", "Modelo 4", "Modelo 5", "Modelo 6", "Modelo 7"),
RMSE = c(rmse_m1, rmse_m2, rmse_m3, rmse_m4, rmse_m5, rmse_m6, rmse_m7)
)

# Visualizar los RMSE en un gráfico de barras

RMSE_barras <- ggplot(mse_values, aes(x = Modelo, y = RMSE, fill = Modelo)) +
geom_bar(stat = "identity", show.legend = FALSE) +
labs(title = "Comparación de RMSE entre Modelos",
x = "Modelo", y = "RMSE") +
theme_minimal()

print(RMSE_barras)
```

Rendimiento General de los Modelos:

El análisis comparativo de los modelos de regresión revela que, en general, el rendimiento predictivo es modesto, como lo indican los bajos valores de R-cuadrado y los RMSE relativamente altos. Esto sugiere que la variabilidad en el logaritmo del salario por hora no se explica completamente por las variables incluidas en los modelos. A pesar de esto, se observa una mejora en el ajuste cuando se incorporan la edad y su término cuadrático, lo que destaca la importancia de considerar la no linealidad en la relación entre la edad y el salario. El modelo 6, en particular, presenta el menor error de predicción (RMSE de 0.6173), indicando un mejor rendimiento en comparación con las otras especificaciones. Además, el modelo que incluye las horas trabajadas, el género y la edad muestra el mejor ajuste a los datos de entrenamiento, lo que sugiere que estas variables son relevantes para predecir el salario por hora.

Especificación con el Menor Error de Predicción:

El modelo 6 se destaca por tener el menor error de predicción (RMSE de 0.6173) entre todas las especificaciones evaluadas. Sin embargo, para proporcionar un análisis más detallado de este modelo, sería necesario conocer las variables específicas que lo componen. El modelo que mejor se ajusta a los datos de entrenamiento es aquel que incluye las horas trabajadas, el género y la edad, lo que sugiere que estas variables son determinantes importantes del salario por hora.

Exploración de Observaciones con Errores de Predicción Significativos:

Para el modelo con el menor error de predicción (Modelo 6), se propone calcular los errores de predicción en el conjunto de prueba y examinar su distribución. Identificar las observaciones con errores grandes, tanto positivos como negativos, permitirá analizar sus características y determinar si representan outliers genuinos o errores del modelo. Los outliers podrían ser de interés para la DIAN si representan individuos con ingresos atípicos y bajos impuestos declarados, aunque también podrían ser producto de las limitaciones del modelo. Se recomienda realizar un análisis más profundo de las variables del Modelo 6 y considerar la inclusión de variables adicionales para mejorar la precisión predictiva.
