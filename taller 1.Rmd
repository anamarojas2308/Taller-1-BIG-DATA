---
title: "Primer Taller big data"
author: "Julian Delgado Gutierrez"
date: "2025-02-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
rm(list = ls())

load.lib <- c('data.table', 'plyr', 'doBy', 'outreg', 'margins', 'ggplot2', 
              'stargazer', 'tidyverse', 'dplyr', 'lubridate', 'ggthemes', 
              'plotly', 'haven', 'devtools', 'openxlsx', 'ggTimeSeries', 
              'gganimate', 'gifski', 'ggiraph', 'sf', 'stringr', 
              'rvest', 'rebus', 'purrr', 'tidytext', 'syuzhet', 
              'tokenizers', 'tm', 'wordcloud', 'cluster', 
              'topicmodels', 'SnowballC', 'pacman', 'skimr',
              'rio', 'gridExtra', 'corrplot', 'MASS','RSelenium','rvest','wdman')

install.lib <- load.lib[!load.lib %in% installed.packages()]
for(lib in install.lib) install.packages(lib)
sapply(load.lib, require, character = TRUE)

print("Librerías cargadas")
```

Web Scraping
```{r setup, include=FALSE}
url_base <- "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_page_"

# Leer la primera página
pagina <- read_html(paste0(url_base, "1.html"))
datos_totales <- pagina %>% html_table(fill = TRUE) %>% .[[1]]

# Iterar sobre las páginas 2 a 10
for (i in 2:10) {
  url <- paste0(url_base, i, ".html")
  tryCatch({
    pagina <- read_html(url)
    tabla <- pagina %>% html_table(fill = TRUE) %>% .[[1]]
    datos_totales <- bind_rows(datos_totales, tabla)
    message(paste("Página", i, "scrapeada correctamente."))
  }, error = function(e) {
    message(paste("Error al cargar la página", i, ":", e))
  })
}

head(datos_totales)
```

Renombrar Columnas
```{r setup, include=FALSE}
datos_totales <- datos_totales %>%
  rename(
    ingreso_total = ingtot,
    edad = age,
    hombre = sex,
    T_horas_trabajadas = totalHoursWorked,
    Salario_hora = y_salary_m_hu
  )
```

Identificación de Valores Faltantes
```{r setup, include=FALSE}
# Contar NA por columna
na_counts <- data.frame(
  Variable = c("ingreso_total", "edad", "hombre", "T_horas_trabajadas", "Salario_hora"),
  NAs = c(
    sum(is.na(datos_totales$ingreso_total)),
    sum(is.na(datos_totales$edad)),
    sum(is.na(datos_totales$hombre)),
    sum(is.na(datos_totales$T_horas_trabajadas)),
    sum(is.na(datos_totales$Salario_hora))
  )
)

# Mostrar los resultados
na_counts <- na_counts %>% arrange(desc(NAs))
print(na_counts)
```

Filtrar Observaciones No Válidas
```{r setup, include=FALSE}
# Filtro de edad, ingreso y horas trabajadas
datos_filtrados <- datos_totales %>% filter(edad >= 18, ingreso_total > 0, T_horas_trabajadas > 0, Salario_hora > 0)

# Crear la variable logarítmica `ln_Salario_hora`
datos_filtrados <- datos_filtrados %>%
  mutate(ln_Salario_hora = log(Salario_hora))
```

División de Datos en Entrenamiento y Prueba (Enfoque Basado en Clase)
```{r setup, include=FALSE}
set.seed(10101)

# Crear una columna de identificación
datos_filtrados$id <- 1:nrow(datos_filtrados)

# Seleccionar el 70% de las filas para el conjunto de entrenamiento
datos_entrenamiento <- datos_filtrados %>% dplyr::sample_frac(0.7)

# El resto de las filas se utilizarán como conjunto de prueba
datos_prueba <- datos_filtrados %>% dplyr::anti_join(datos_entrenamiento, by = "id")

# Verificar tamaños
cat("Tamaño del conjunto de entrenamiento:", nrow(datos_entrenamiento), "\n")
cat("Tamaño del conjunto de prueba:", nrow(datos_prueba), "\n")
```

Modelos de Regresión

Modelo 1: Constante
```{r setup, include=FALSE}
modelo1 <- lm(ln_Salario_hora ~ 1, data = datos_entrenamiento)
summary(modelo1)
```

Modelo 2: Edad y Edad^2
```{r setup, include=FALSE}
modelo2 <- lm(ln_Salario_hora ~ edad + I(edad^2), data = datos_entrenamiento)
summary(modelo2)
```

Modelo 3: Género y Edad
```{r setup, include=FALSE}
modelo3 <- lm(ln_Salario_hora ~ hombre + edad, data = datos_entrenamiento)
summary(modelo3)
```

Predicciones y Evaluación del Modelo
Generar Predicciones
```{r setup, include=FALSE}
datos_prueba$prediccion_m1 <- predict(modelo1, newdata = datos_prueba)
datos_prueba$prediccion_m2 <- predict(modelo2, newdata = datos_prueba)
datos_prueba$prediccion_m3 <- predict(modelo3, newdata = datos_prueba)
```

Calcular RMSE
```{r setup, include=FALSE}
rmse <- function(actual, predicho) {
  sqrt(mean((actual - predicho)^2))
}

rmse_m1 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m1)
rmse_m2 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m2)
rmse_m3 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m3)

# Mostrar resultados
print(paste("RMSE Modelo 1:", round(rmse_m1, 4)))
print(paste("RMSE Modelo 2:", round(rmse_m2, 4)))
print(paste("RMSE Modelo 3:", round(rmse_m3, 4)))
```
Modelos Adicionales
```{r setup, include=FALSE}
# Modelo 4: Polinomio cúbico en edad
modelo4 <- lm(ln_Salario_hora ~ poly(edad, 3, raw = TRUE), data = datos_entrenamiento)

# Modelo 5: Interacción entre género y edad
modelo5 <- lm(ln_Salario_hora ~ hombre * edad, data = datos_entrenamiento)

# Modelo 6: Modelo con todas las covariables
modelo6 <- lm(ln_Salario_hora ~ hombre + edad + I(edad^2) + T_horas_trabajadas, data = datos_entrenamiento)

# Modelo 7: Polinomios y log(T_horas_trabajadas)
modelo7 <- lm(ln_Salario_hora ~ poly(edad, 2) + log(T_horas_trabajadas), data = datos_entrenamiento)
```

Predicciones y RMSE para los Modelos Adicionales
```{r setup, include=FALSE}
# Predicciones para los nuevos modelos
datos_prueba$prediccion_m4 <- predict(modelo4, newdata = datos_prueba)
datos_prueba$prediccion_m5 <- predict(modelo5, newdata = datos_prueba)
datos_prueba$prediccion_m6 <- predict(modelo6, newdata = datos_prueba)
datos_prueba$prediccion_m7 <- predict(modelo7, newdata = datos_prueba)

# Calcular RMSE para todos los modelos
rmse_m4 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m4)
rmse_m5 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m5)
rmse_m6 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m6)
rmse_m7 <- rmse(datos_prueba$ln_Salario_hora, datos_prueba$prediccion_m7)

# Comparar en una tabla
rmse_comparacion <- data.frame(
  Modelo = c("Modelo 1", "Modelo 2", "Modelo 3", "Modelo 4", "Modelo 5", "Modelo 6", "Modelo 7"),
  RMSE = c(rmse_m1, rmse_m2, rmse_m3, rmse_m4, rmse_m5, rmse_m6, rmse_m7)
)

print(rmse_comparacion)
```

LOOCV para Modelos Específicos
```{r setup, include=FALSE}
# LOOCV para el Modelo 2
mse_loocv_modelo2 <- numeric(nrow(datos_filtrados))
for (i in 1:nrow(datos_filtrados)) {
  datos_entrenamiento <- datos_filtrados[-i, ]
  datos_prueba <- datos_filtrados[i, ]
  modelo_loocv <- lm(ln_Salario_hora ~ edad + I(edad^2), data = datos_entrenamiento)
  prediccion <- predict(modelo_loocv, newdata = datos_prueba)
  mse_loocv_modelo2[i] <- (datos_prueba$ln_Salario_hora - prediccion)^2
}
loocv_error_modelo2 <- mean(mse_loocv_modelo2)
print(paste("LOOCV Error para Modelo 2:", round(loocv_error_modelo2, 4)))

# LOOCV para el Modelo 3
mse_loocv_modelo3 <- numeric(nrow(datos_filtrados))
for (i in 1:nrow(datos_filtrados)) {
  datos_entrenamiento <- datos_filtrados[-i, ]
  datos_prueba <- datos_filtrados[i, ]
  modelo_loocv <- lm(ln_Salario_hora ~ hombre + edad, data = datos_entrenamiento)
  prediccion <- predict(modelo_loocv, newdata = datos_prueba)
  mse_loocv_modelo3[i] <- (datos_prueba$ln_Salario_hora - prediccion)^2
}
loocv_error_modelo3 <- mean(mse_loocv_modelo3)
print(paste("LOOCV Error para Modelo 3:", round(loocv_error_modelo3, 4)))
```
